import folium
import pandas as pd
import json
from folium import plugins

#CSV com localização das lojas
df = pd.read_csv('starbucksInLACounty.csv')

#shape de Los Angeles
with open('laMap.geojson') as f:
	laArea = json.load(f)

#starta o mapa como objeto folium
mapa = folium.Map(location=[34.0522,-118.2437], tiles='Stamen Toner', zoom_start=9)

#adiciona o shape
folium.GeoJson(laArea).add_to(mapa)

#extrai a longitude e latitude de cada linha ,  cada qual um ponto
#plot no mapa cada ponto em forma de circulos
for i,row in df.iterrows():
    folium.CircleMarker((row.latitude,row.longitude), radius=3, weight=2, color='red', fill_color='red', fill_opacity=.5).add_to(mapa)

#salva o mapa em html
mapa.save('laPointMap.html')

#########################
#Mapa coropletico

#agrupa as loja pelo CEP (ZIP CODE)
#groupby é um método do pandas

numStoresSeries = df.groupby('zip').count().id
#novo dataframe em branco
numStoresByZip = pd.DataFrame()

#adiciona uma coluna de ZIPCODE, e outra com a quantia de lojas
numStoresByZip['zipcode'] = [str(i) for i in numStoresSeries.index]
numStoresByZip['numStores'] = numStoresSeries.values

#print para debugar
#print(numStoresByZip)

#folium.Choropleth(geo_path='laZips.geojson', geo_data=numStoresByZip, columns=['zipcode', #'numStores'], key_on='feature.properties.zipcode', fill_color='YlGn', fill_opacity=1)


folium.Choropleth(
    geo_data='laZips.geojson',
    name='choropleth',
    data=numStoresByZip,
    columns=['zipcode', 'numStores'],
    key_on='feature.properties.zipcode',
    fill_color='YlGn',
    fill_opacity=0.7,
    line_opacity=0.2,
    legend_name='Unemployment Rate (%)'
).add_to(mapa)

mapa.save('laChoropleth.html')


#########################
#Mapa de Calor

#initialize the LA County map
laMap = folium.Map(location=[34.0522,-118.2437], tiles='Stamen Toner', zoom_start=9)

#add the shape of LA County to the map
folium.GeoJson(laArea).add_to(laMap)

#for each row in the Starbucks dataset, plot the corresponding latitude and longitude on the map
for i,row in df.iterrows():
    folium.CircleMarker((row.latitude,row.longitude), radius=3, weight=2, color='red', fill_color='red', fill_opacity=.5).add_to(laMap)

#add the heatmap. The core parameters are:
#--data: a list of points of the form (latitude, longitude) indicating locations of Starbucks stores

#--radius: how big each circle will be around each Starbucks store

#--blur: the degree to which the circles blend together in the heatmap

laMap.add_child(plugins.HeatMap(data=df[['latitude', 'longitude']].as_matrix(), radius=25, blur=10))

#save the map as an html
laMap.save('laHeatmap.html')